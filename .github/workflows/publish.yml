name: Deploy Laravel to Railway

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 🧩 Checkout repository
        uses: actions/checkout@v4

      - name: ⚙️ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, bcmath, pdo_mysql, zip, curl, gd
          coverage: none

      - name: 🪄 Validate composer.json and composer.lock
        run: composer validate --no-check-lock --no-interaction

      - name: Install Node dependencies
        run: npm ci

      - name: Build frontend assets
        run: npm run build

      - name: 📦 Install dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: ⚡ Optimize Laravel
        run: |
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

      - name: 🚀 Deploy Laravel Web Service
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Deploying Laravel web service..."
          railway up --service laravel-web


      - name: ⏰ Deploy Laravel Scheduler
        env:
           RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
         echo "Deploying Laravel scheduler..."
         railway up --service laravel-scheduler
